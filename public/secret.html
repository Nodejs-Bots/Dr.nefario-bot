<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Secret Logs</title>
<style>
  :root{
    --bg:#0e0f12;
    --panel:#151618;
    --accent:#ff8c42;
    --text:#dfe6e9;
    --muted:#98a8b3;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  .wrap{max-width:1000px;margin:28px auto;padding:18px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 6px 24px rgba(0,0,0,0.6);}
  h1{margin:0 0 14px;color:var(--accent);font-size:20px}
  .controls{display:flex;gap:10px;align-items:center;margin-bottom:12px}
  .btn{background:var(--accent);border:none;color:#0b0b0b;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600}
  .btn.secondary{background:#2b2f33;color:var(--text)}
  #logs{background:var(--panel);border:1px solid #232629;border-radius:8px;padding:12px;height:64vh;overflow:auto;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;font-size:13px;line-height:1.35}
  .muted{color:var(--muted);font-size:13px}
  .hidden{display:none}
  .statusline{margin-bottom:8px;color:var(--muted);font-size:13px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ”’ Secret Logs</h1>

    <div id="auth-section" class="">
      <p class="muted">This page is protected. Enter the owner password to view logs.</p>
      <div class="controls">
        <input id="pw" type="password" placeholder="Password" style="padding:8px;border-radius:6px;border:1px solid #222;background:#0b0b0b;color:var(--text);flex:1" />
        <button id="pwBtn" class="btn">Unlock</button>
        <button id="backBtn" class="btn secondary" onclick="location.href='/dashboard.html'">Back</button>
      </div>
      <p id="authMsg" class="muted"></p>
    </div>

    <div id="content" class="hidden">
      <div class="controls" style="justify-content:space-between;">
        <div class="statusline">
          <span id="lastUpdated">Last updated: â€”</span>
          <span style="margin-left:12px" id="entryCount"></span>
        </div>
        <div>
          <button id="refreshBtn" class="btn secondary">Refresh</button>
          <button id="clearBtn" class="btn secondary">Clear</button>
        </div>
      </div>

      <div id="logs">Loading logsâ€¦</div>
    </div>
  </div>

<script>
(function(){
  const CORRECT = "owner77"; // password
  const pwEl = document.getElementById("pw");
  const pwBtn = document.getElementById("pwBtn");
  const authMsg = document.getElementById("authMsg");
  const authSection = document.getElementById("auth-section");
  const content = document.getElementById("content");
  const logsEl = document.getElementById("logs");
  const lastUpdatedEl = document.getElementById("lastUpdated");
  const entryCountEl = document.getElementById("entryCount");
  const refreshBtn = document.getElementById("refreshBtn");
  const clearBtn = document.getElementById("clearBtn");

  let unlocked = false;
  let pollHandle = null;

  function showAccessDenied() {
    authMsg.textContent = "Wrong password. Access denied.";
    authMsg.style.color = "#ff7777";
  }

  function enableContent() {
    unlocked = true;
    authSection.classList.add("hidden");
    content.classList.remove("hidden");
    fetchAndRenderLogs(); // initial
    pollHandle = setInterval(fetchAndRenderLogs, 5000);
  }

  pwBtn.addEventListener("click", () => {
    const v = pwEl.value || "";
    if (v === CORRECT) {
      enableContent();
    } else {
      showAccessDenied();
    }
  });

  // allow Enter key
  pwEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") pwBtn.click();
  });

  refreshBtn.addEventListener("click", fetchAndRenderLogs);
  clearBtn.addEventListener("click", () => {
    if (!confirm("Clear local log display? (server logs remain)")) return;
    logsEl.textContent = "";
    entryCountEl.textContent = "";
  });

  async function fetchAndRenderLogs() {
    try {
      const res = await fetch("/logs", { cache: "no-store" });
      if (!res.ok) {
        logsEl.textContent = "Failed to fetch logs: " + res.status + " " + res.statusText;
        return;
      }

      const txt = await res.text();

      // Try parse JSON first (some server variants return JSON array)
      let entries = null;
      try {
        const parsed = JSON.parse(txt);
        if (Array.isArray(parsed)) entries = parsed.map(e => {
          // if entries are objects with timestamp/message
          if (typeof e === "object" && e !== null) {
            if (e.timestamp && e.message) return `[${e.timestamp}] ${e.message}`;
            // stringify fallback
            return JSON.stringify(e);
          }
          return String(e);
        });
      } catch (e) {
        // not JSON â€” fall back to plain text
      }

      if (!entries) {
        // treat as newline-separated text
        // Normalize CRLF -> LF
        const lines = txt.replace(/\r\n/g, "\n").split("\n").filter(Boolean);
        entries = lines;
      }

      // Render
      logsEl.textContent = entries.join("\n");
      lastUpdatedEl.textContent = "Last updated: " + new Date().toLocaleString();
      entryCountEl.textContent = `Entries: ${entries.length}`;

      // Auto-scroll to bottom
      logsEl.scrollTop = logsEl.scrollHeight;
    } catch (err) {
      logsEl.textContent = "Error fetching logs: " + err.message;
    }
  }

  // cleanup on unload
  window.addEventListener("beforeunload", () => {
    if (pollHandle) clearInterval(pollHandle);
  });
})();
</script>
</body>
</html>
